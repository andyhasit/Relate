"use strict";var c=console;angular.module("Relate",[]),angular.module("Relate").factory("BaseCollection",["$q",function(e){var n=function(){var e=this;e.__index=null,e.__db=null,e.dbDocumentType=null},t=n.prototype;return t.__postAndLoad=function(n){var t=this,i=e.defer();return n.type=t.dbDocumentType,t.__db.post(n).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";t.__db.get(e.id).then(function(e){i.resolve(t.loadDocumentFromDb(e))})}),i.promise},n}]),angular.module("Relate").factory("Collection",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var r=this,i=i||{};r.itemName=n,r.collectionName=n,r.plural=i.plural||n+"s",r.dbDocumentType=i.dbDocumentType||n,r.__db=e,r.__factoryFunction=i.factoryFunction||function(){},r.__items={},r.__relationships=[],r.__fieldNames=t.slice(),r.__fullFieldNames=t.slice(),r.__fullFieldNames.push("_id"),r.__fullFieldNames.push("_rev")};e.inheritPrototype(i,t);var r=i.prototype;return r.registerRelationship=function(e){var n=this;n.__relationships.push(e)},r.loadDocumentFromDb=function(n){var t=this,i=new t.__factoryFunction;return e.copyFields(n,i,t.__fullFieldNames),t.__items[n._id]=i,i},r.getAccessFunctionDefinitions=function(){function n(n,i,l){var a=i?n+o:n+r,c=t["__"+n+"__"];return e.createAccessFunctionDefinition(a,c,l)}var t=this,i=e.capitalizeFirstLetter,r=i(t.itemName),o=i(t.plural);return[n("new",!1,!0),n("save",!1,!0),n("delete",!1,!0),n("get",!1,!1),n("find",!0,!1),n("all",!0,!1)]},r.__get__=function(e){var n=this;return n.__items[e]},r.__all__=function(){var e=this;return Object.keys(e.__items).map(function(n){return e.__items[n]})},r.__find__=function(n){var t,i=this;if("function"==typeof n)t=n;else{if("object"!=typeof n)throw'Invalid argument for "find", must be an object or a function.';t=function(e){for(prop in n)if(e[prop]!==n[prop])return!1;return!0}}return e.filterIndex(i.__items,t)},r.__new__=function(t){var i=this,r=n.defer(),o={};return e.copyFields(t,o,i.__fieldNames),i.__postAndLoad(o).then(function(e){r.resolve(e)}),r.promise},r.__save__=function(t){var i=this,r=n.defer(),o={};return e.copyFields(t,o,i.__fullFieldNames),i.__db.put(o).then(function(e){t._rev=e.rev,r.resolve(t._rev)}),r.promise},r.__delete__=function(e){var t=this,i=n.defer(),r=[];return angular.forEach(t.__relationships,function(n){r.push(n.respondToItemDeleted(e,t))}),n.all(r).then(function(){t.__db.remove(e).then(function(n){delete t.__items[e._id],i.resolve()})}),i.promise},i}]),angular.module("Relate").factory("ItemChildrenRegister",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var r=this,i=i||{},o=i.childAlias||t.itemName,l=i.parentAlias||n.itemName;r.dbDocumentType="lnk_child_"+o+"s_of_"+l,r.__db=e,r.__parentCollection=n,r.__childCollection=t,r.__cascadeDelete=i.cascadeDelete||!1,r.__index={},r.__reverseIndex={}};e.inheritPrototype(i,t);var r=i.prototype;return r.loadDocumentFromDb=function(e){var n=this,t=e.parentId;if(n.__index[t])throw"Found duplicate item children link in database.";var i={doc:e};return n.__index[t]=i,angular.forEach(e.childrenIds,function(e){n.__reverseIndex[e]=t}),i},r.getChildren=function(e){var n=this,t=n.__index[e._id];return t?(n.__ensureIndexEntryHasLiveChildren(t),t.liveChildren):[]},r.linkChildToParent=function(e,t){var i,r=this,o=n.defer(),l=e?e._id:null,a=r.__index[l];return r.__unlinkChildFromPreviousParent(t).then(function(){r.__reverseIndex[t._id]=l,i=a?r.__addChildToIndexEntry(a,t):r.__postAndLoad({parentId:e._id,childrenIds:[t._id]}),i.then(function(){o.resolve()})}),o.promise},r.respondToParentDeleted=function(e){var t=this,i=n.defer();if(indexEntry=t.__index[e._id],indexEntry){if(t.__cascadeDelete&&indexEntry.doc.childrenIds.length>0)throw debug(indexEntry),"Cannot delete parent object as it still has children";t.__db.remove(indexEntry.doc).then(function(){delete t.__index[e._id],i.resolve()})}return i.promise},r.respondToChildDeleted=function(e){var n=this;return n.__unlinkChildFromPreviousParent(e)},r.__addChildToIndexEntry=function(t,i){var r=this,o=n.defer();return r.__ensureIndexEntryHasLiveChildren(t),e.arrayContains(t.doc.childrenIds,i._id)?o.resolve():(t.doc.childrenIds.push(i.Id),r.__db.put(t.doc).then(function(){t.liveChildren.push(i),o.resolve()})),o.promise},r.__unlinkChildFromPreviousParent=function(t){var i=this,r=n.defer(),o=i.__reverseIndex[t._id];if(o){var l=i.__index[o];e.removeFromArray(l.doc.childrenIds,t._id),i.__reverseIndex[t._id]=null,i.__db.put(l.doc).then(function(){i.__ensureIndexEntryHasLiveChildren(l),e.removeFromArray(l.liveChildren,t),r.resolve()})}else r.resolve();return r.promise},r.__ensureIndexEntryHasLiveChildren=function(e){var n=this,t=e.liveChildren;if(!t){var t=[];angular.forEach(e.doc.childrenIds,function(e){t.push(n.__childCollection.__get__(e))}),e.liveChildren=t}},i}]),angular.module("Relate").factory("ItemParentRegister",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var r=this,i=i||{},o=i.childAlias||t.itemName,l=i.parentAlias||n.itemName;r.dbDocumentType="lnk_parent_"+l+"_of_"+o,r.__db=e,r.__index={},r.__parentCollection=n};e.inheritPrototype(i,t);var r=i.prototype;return r.loadDocumentFromDb=function(e){var n=this;if(n.__index[e.childId])throw"Found duplicate item parent link in database.";var t={document:e};return n.__index[e.childId]=t,t},r.getParent=function(e){var n=this,t=n.__index[e._id];return t?(angular.isUndefined(t.liveObject)&&(t.liveObject=n.__parentCollection.__get__(t.document.parentId)||null),t.liveObject):null},r.linkChildToParent=function(e,t){var i=this,r=n.defer(),o=e?e._id:null,l=i.__index[t._id];return l?(l.document.parentId=o,i.__db.put(l.document).then(function(n){l.document._rev=n.rev,l.liveObject=e,r.resolve()})):i.__postAndLoad({parentId:o,childId:t._id}).then(function(e){r.resolve()}),r.promise},r.respondToChildDeleted=function(e){var t=this,i=n.defer(),r=e._id,o=t.__index[r];return o&&t.__db.remove(o.document).then(function(e){delete t.__index[r],i.resolve()}),i.promise},i}]),angular.module("Relate").service("model",["$q","Collection","ParentChildRelationship",function(e,n,t){function i(e){var n=e.parent,i=e.child,r=h[n],o=h[i];return new t(d,r,o,e)}function r(e){angular.forEach(e,function(e){var n;n=e.queuedPromise?l(collection,e.collectionFunction):o(collection,e.collectionFunction),f[e.ModelFunctionName]=n})}function o(e,n){return function(){return n.apply(e,arguments)}}function l(n,t){return function(){var i=arguments,r=e.defer();return v.then(function(){v=t.apply(n,i),v.then(function(e){r.resolve(e)})}),r.promise}}function a(e){var n=e.dbDocumentType;if(n in m){m[n];throw'More than one collection/relationship attempting to register dbDocumentType: "'+n+'".'}m[n]=e}function c(){var n=e.defer(),t=_();return t.then(function(e){angular.forEach(e.rows,function(e){u(e.doc)}),s(),n.resolve()})["catch"](function(e){console.log(e)}),n.promise}function u(e){var n=e.type;if(!n)throw'Could not load document "'+e._id+'" as it has no "type" field.';var t=m[n];t?t.loadDocumentFromDb(e,n):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+n+")"))}function s(){angular.forEach(p,function(e){})}var d,_,f=this,h={},p={},m={},v=e.when(),g={};f.initialize=function(e,n){d=e,_=n||function(){return d.allDocs({include_docs:!0,attachments:!1})}};var y;f.dataReady=function(){return void 0===y&&(y=e.defer(),c().then(function(){y.resolve()})),y.promise},f.printInfo=function(){angular.forEach(h,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},f.defineCollection=function(e,t,i){var o=new n(d,e,t,i);return h[o.collectionName]=o,a(o),r(o.getAccessFunctionDefinitions()),o},f.defineRelationship=function(e){var n=e.type,t=g[n];if("function"!=typeof t)throw""+e.type+" is not a valid relationship type";relationship=t.apply(f,[e]),r(relationship.getAccessFunctionDefinitions()),p[relationship.collectionName]=relationship},g.parentChild=i}]),angular.module("Relate").factory("ParentChildRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,n,t,i,r){var o=function(e,r,o,l){var a=this,l=l||{};a.__parentCollectionName=r.itemName,a.__childCollectionName=o.itemName,a.__childAlias=l.childAlias||o.plural,a.__parentAlias=l.parentAlias||r.itemName,a.__parentDeleteInProgress=new i,a.__parentCollection=r,a.__childCollection=o,a.__cascadeDelete=l.cascadeDelete||!0,a.itemParentRegister=new n(e,r,o,l),a.itemChildrenRegister=new t(e,r,o,l),r.registerRelationship(a),o.registerRelationship(a)},l=o.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,n=r.capitalizeFirstLetter,t="get"+n(e.__childCollectionName)+n(e.__parentAlias),i="get"+n(e.__parentCollectionName)+n(e.__childAlias),o="set"+n(e.__childCollectionName)+n(e.__parentAlias);return[r.createAccessFunctionDefinition(t,e.__getParent__),r.createAccessFunctionDefinition(i,e.__getChildren__),r.createAccessFunctionDefinition(o,e.__setChildParent__)]},l.createLinks=function(){},l.__getParent__=function(e){},l.__getChildren__=function(e){},l.__setChildParent__=function(n,t){var i=this;return e.all([i.itemParentRegister.linkChildToParent(t,n),i.itemChildrenRegister.linkChildToParent(t,n)])},l.respondToItemDeleted=function(e,n){},l.__respondToParentDeleted=function(n){var t=this,i=e.defer();t.__parentDeleteInProgress.set(n,!0);var r=[];return t.__cascadeDelete&&angular.forEach(t.__getChildren__(n),function(e){r.push(t.__childCollection.__delete__(e))}),t.__parentDeleteInProgress.set(n,!1),e.all(r).then(function(){t.itemChildrenRegister.respondToParentDeleted(n),i.resolve()}),i.promise},l.__respondToChildDeleted=function(n){var t=this,i=e.defer(),r=[],o=t.__getParent__(n);return r.push(t.itemParentRegister.respondToChildDeleted(n)),o&&!t.__parentDeleteInProgress.get(o)&&r.push(t.itemChildrenRegister.respondToChildDeleted(n)),e.all(r).then(function(){i.resolve()}),i.promise},o}]),angular.module("Relate").factory("QueuedResponseDb",["$q","ValueRegister",function(e,n){var t=function(n){var t=this;t._db=n,t.queue={},t._nextId=0,t._latestResolvedId=1,t.wrapPromise=function(n,i){var r=t.nextId(),o=t._db[n](i),l=e.defer();return t.queuePromise(r,l),o.then(function(e){t.promiseGotResolved(r,e)}),l.promise},angular.forEach(["post","put","get","remove"],function(e){t[e]=function(n){return t.wrapPromise(e,n)}})};return t.prototype.nextId=function(){return this._nextId++,this._nextId},t.prototype.queuePromise=function(e,n){this.queue[e]={returnPromise:n,resolved:!1}},t.prototype.promiseGotResolved=function(e,n){var t=this.queue[e];t.result=n,t.resolved=!0,this.releasResolvedPromises()},t.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},t}]),angular.module("Relate").factory("ParentRelationshipNew",["$q",function(e){var n=function(e,n,t){this.propertyName=e,this._parentCollection=n,this._parentPopertyName=t};n.prototype._convertFromDoc=function(e){var n=e[this.propertyName];n&&this._parentCollection.getItem(n)},n.prototype._convertToDoc=function(e){return e.id},n.prototype._onItemRemove=function(e){var n=doc[this.propertyName];if(n){var t=this._parentCollection.getItem(n);t&&t._links[this._parentPopertyName]}}}]),angular.module("Relate").service("util",["$q",function(e){var n=this;n.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},n.createAccessFunctionDefinition=function(e,n,t){return{ModelFunctionName:e,collectionFunction:n,queuedPromise:t}},n.arrayContains=function(e,n){for(var t=e.length,i=0;t>=i;i++)if(n==e[i])return!0;return!1},n.removeFromArray=function(e,n){var t=e.indexOf(n);t>-1&&e.splice(t,1)},n.filterIndex=function(e,n){var t=[];return angular.forEach(e,function(e){n(e)&&t.push(e)}),t},n.inheritPrototype=function(e,n){var t=e.prototype,i=n.prototype;for(var r in i)"function"==typeof i[r]&&(t[r]=i[r])},n.copyFields=function(e,n,t){angular.forEach(t,function(t){n[t]=e[t]})}}]),angular.module("Relate").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,n){this._register[e]=n},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=relate.min.js.map
