"use strict";var c=console;angular.module("Relate",[]),angular.module("Relate").factory("BaseCollection",["$q",function(e){var t=function(){var e=this;e.__index=null,e.__db=null,e.dbDocumentType=null},n=t.prototype;return n.__postAndLoad=function(t){var n=this,r=e.defer();return t.type=n.dbDocumentType,n.__db.post(t).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";n.__db.get(e.id).then(function(e){r.resolve(n.loadDocumentFromDb(e))})}),r.promise},t}]),angular.module("Relate").factory("Collection",["util","$q","BaseCollection",function(e,t,n){var r=function(e,t,n,r){var i=this,r=r||{};i.itemName=t,i.collectionName=t,i.plural=r.plural||t+"s",i.dbDocumentType=r.dbDocumentType||t,i.__db=e,i.__factoryFunction=r.factoryFunction||function(){},i.__items={},i.__relationships=[],i.__fieldNames=n.slice(),i.__fullFieldNames=n.slice(),i.__fullFieldNames.push("_id"),i.__fullFieldNames.push("_rev")};e.inheritPrototype(r,n);var i=r.prototype;return i.registerRelationship=function(e){var t=this;t.__relationships.push(e)},i.loadDocumentFromDb=function(t){var n=this,r=new n.__factoryFunction;return e.copyFields(t,r,n.__fullFieldNames),n.__items[t._id]=r,r},i.getAccessFunctionDefinitions=function(){function t(t,r,l){var a=r?t+o:t+i,c=n["__"+t+"__"];return e.createAccessFunctionDefinition(a,c,l)}var n=this,r=e.capitalizeFirstLetter,i=r(n.itemName),o=r(n.plural);return[t("new",!1,!0),t("save",!1,!0),t("delete",!1,!0),t("get",!1,!1),t("find",!0,!1),t("all",!0,!1)]},i.__get__=function(e){var t=this;return t.__items[e]},i.__all__=function(){var e=this;return Object.keys(e.__items).map(function(t){return e.__items[t]})},i.__find__=function(t){var n,r=this;if("function"==typeof t)n=t;else{if("object"!=typeof t)throw'Invalid argument for "find", must be an object or a function.';n=function(e){for(prop in t)if(e[prop]!==t[prop])return!1;return!0}}return e.filterIndex(r.__items,n)},i.__new__=function(n){var r=this,i=t.defer(),o={};return e.copyFields(n,o,r.__fieldNames),r.__postAndLoad(o).then(function(e){i.resolve(e)}),i.promise},i.__save__=function(n){var r=this,i=t.defer(),o={};return e.copyFields(n,o,r.__fullFieldNames),r.__db.put(o).then(function(e){n._rev=e.rev,i.resolve(n._rev)}),i.promise},i.__delete__=function(e){var n=this,r=t.defer(),i=[];return angular.forEach(n.__relationships,function(t){i.push(t.respondToItemDeleted(e,n))}),t.all(i).then(function(){n.__db.remove(e).then(function(t){delete n.__items[e._id],r.resolve()})}),r.promise},r}]),angular.module("Relate").factory("ItemChildrenRegister",["util","$q","BaseCollection",function(e,t,n){var r=function(e,t,n,r){var i=this,r=r||{},o=r.childAlias||n.itemName,l=r.parentAlias||t.itemName;i.dbDocumentType="lnk_child_"+o+"s_of_"+l,i.__db=e,i.__parentCollection=t,i.__childCollection=n,i.__cascadeDelete=r.cascadeDelete||!1,i.__index={},i.__reverseIndex={}};e.inheritPrototype(r,n);var i=r.prototype;return i.loadDocumentFromDb=function(e){var t=this,n=e.parentId;if(t.__index[n])throw"Found duplicate item children link in database.";var r={doc:e};return t.__index[n]=r,angular.forEach(e.childrenIds,function(e){t.__reverseIndex[e]=n}),r},i.getChildren=function(e){var t=this,n=t.__index[e._id];return n?(t.__ensureIndexEntryHasLiveChildren(n),n.liveChildren):[]},i.linkChildToParent=function(e,n){var r,i=this,o=t.defer(),l=e?e._id:null,a=i.__index[l];return i.__unlinkChildFromPreviousParent(n).then(function(){i.__reverseIndex[n._id]=l,r=a?i.__addChildToIndexEntry(a,n):i.__postAndLoad({parentId:e._id,childrenIds:[n._id]}),r.then(function(){o.resolve()})}),o.promise},i.respondToParentDeleted=function(e){var n=this,r=t.defer();if(indexEntry=n.__index[e._id],indexEntry){if(n.__cascadeDelete&&indexEntry.doc.childrenIds.length>0)throw debug(indexEntry),"Cannot delete parent object as it still has children";n.__db.remove(indexEntry.doc).then(function(){delete n.__index[e._id],r.resolve()})}return r.promise},i.respondToChildDeleted=function(e){var t=this;return t.__unlinkChildFromPreviousParent(e)},i.__addChildToIndexEntry=function(n,r){var i=this,o=t.defer();return i.__ensureIndexEntryHasLiveChildren(n),e.arrayContains(n.doc.childrenIds,r._id)?o.resolve():(n.doc.childrenIds.push(r.Id),i.__db.put(n.doc).then(function(){n.liveChildren.push(r),o.resolve()})),o.promise},i.__unlinkChildFromPreviousParent=function(n){var r=this,i=t.defer(),o=r.__reverseIndex[n._id];if(o){var l=r.__index[o];e.removeFromArray(l.doc.childrenIds,n._id),r.__reverseIndex[n._id]=null,r.__db.put(l.doc).then(function(){r.__ensureIndexEntryHasLiveChildren(l),e.removeFromArray(l.liveChildren,n),i.resolve()})}else i.resolve();return i.promise},i.__ensureIndexEntryHasLiveChildren=function(e){var t=this,n=e.liveChildren;if(!n){var n=[];angular.forEach(e.doc.childrenIds,function(e){n.push(t.__childCollection.__get__(e))}),e.liveChildren=n}},r}]),angular.module("Relate").factory("ItemParentRegister",["util","$q","BaseCollection",function(e,t,n){var r=function(e,t,n,r){var i=this,r=r||{},o=r.childAlias||n.itemName,l=r.parentAlias||t.itemName;i.dbDocumentType="lnk_parent_"+l+"_of_"+o,i.__db=e,i.__index={},i.__parentCollection=t};e.inheritPrototype(r,n);var i=r.prototype;return i.loadDocumentFromDb=function(e){var t=this;if(t.__index[e.childId])throw"Found duplicate item parent link in database.";var n={document:e};return t.__index[e.childId]=n,n},i.getParent=function(e){var t=this,n=t.__index[e._id];return n?(angular.isUndefined(n.liveObject)&&(n.liveObject=t.__parentCollection.__get__(n.document.parentId)||null),n.liveObject):null},i.linkChildToParent=function(e,n){var r=this,i=t.defer(),o=e?e._id:null,l=r.__index[n._id];return l?(l.document.parentId=o,r.__db.put(l.document).then(function(t){l.document._rev=t.rev,l.liveObject=e,i.resolve()})):r.__postAndLoad({parentId:o,childId:n._id}).then(function(e){i.resolve()}),i.promise},i.respondToChildDeleted=function(e){var n=this,r=t.defer(),i=e._id,o=n.__index[i];return o&&n.__db.remove(o.document).then(function(e){delete n.__index[i],r.resolve()}),r.promise},r}]),angular.module("Relate").service("model",["$q","Collection","ParentChildRelationship",function(e,t,n){function r(e){var t=e.parent,r=e.child,i=_[t],o=_[r],l=new n(u,i,o,e);return _[l.collectionName]=l,a(l.itemParentRegister),a(l.itemChildrenRegister),l}function i(){angular.forEach(_,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(t){var n;n=t.queuedPromise?l(e,t.collectionFunction):o(e,t.collectionFunction),d[t.ModelFunctionName]=n})})}function o(e,t){return function(){return t.apply(e,arguments)}}function l(t,n){return function(){var r=arguments,i=e.defer();return h.then(function(){h=n.apply(t,r),h.then(function(e){i.resolve(e)})}),i.promise}}function a(e){var t=e.dbDocumentType;if(t in f){f[t];throw'More than one collection/relationship attempting to register dbDocumentType: "'+t+'".'}f[t]=e}function c(){var t=e.defer(),n=u.allDocs({include_docs:!0,attachments:!1});return n.then(function(e){angular.forEach(e.rows,function(e){s(e.doc)}),i(),t.resolve()})["catch"](function(e){console.log(e)}),t.promise}function s(e){var t=e.type;if(!t)throw'Could not load document "'+e._id+'" as it has no "type" field.';var n=f[t];n?n.loadDocumentFromDb(e,t):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+t+")"))}var u,d=this,_={},f={},h=e.when(),p={};d.initialize=function(e,t){u=e};var m;d.dataReady=function(){return void 0===m&&(m=e.defer(),c().then(function(){m.resolve()})),m.promise},d.printInfo=function(){angular.forEach(_,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},d.defineCollection=function(e,n,r){var i=new t(u,e,n,r);return _[i.collectionName]=i,a(i),i},d.defineRelationship=function(e){var t=e.type,n=p[t];if("function"==typeof n)return n.apply(d,[e]);throw""+e.type+" is not a valid relationship type"},p.parentChild=r}]),angular.module("Relate").factory("ParentChildRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,t,n,r,i){var o=function(e,i,o,l){var a=this,l=l||{};a.__parentCollectionName=i.itemName,a.__childCollectionName=o.itemName,a.__childAlias=l.childAlias||o.plural,a.__parentAlias=l.parentAlias||i.itemName,a.collectionName="lnk_"+a.__parentAlias+"_"+a.__childAlias,a.__parentDeleteInProgress=new r,a.__parentCollection=i,a.__childCollection=o,a.__cascadeDelete=l.cascadeDelete||!0,a.itemParentRegister=new t(e,i,o,l),a.itemChildrenRegister=new n(e,i,o,l),i.registerRelationship(a),o.registerRelationship(a)},l=o.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,t=i.capitalizeFirstLetter,n="get"+t(e.__childCollectionName)+t(e.__parentAlias),r="get"+t(e.__parentCollectionName)+t(e.__childAlias),o="set"+t(e.__childCollectionName)+t(e.__parentAlias);return[i.createAccessFunctionDefinition(n,e.__getParent__),i.createAccessFunctionDefinition(r,e.__getChildren__),i.createAccessFunctionDefinition(o,e.__setChildParent__)]},l.__getParent__=function(e){var t=this;return t.itemParentRegister.getParent(e)},l.__getChildren__=function(e){var t=this;return t.itemChildrenRegister.getChildren(e)},l.__setChildParent__=function(t,n){var r=this;return e.all([r.itemParentRegister.linkChildToParent(n,t),r.itemChildrenRegister.linkChildToParent(n,t)])},l.respondToItemDeleted=function(e,t){var n=this;if(t===n.__parentCollection)return n.__respondToParentDeleted(e);if(t===n.__childCollection)return n.__respondToChildDeleted(e);throw"Called respondToItemDeleted from wrong collection."},l.__respondToParentDeleted=function(t){var n=this,r=e.defer();n.__parentDeleteInProgress.set(t,!0);var i=[];return n.__cascadeDelete&&angular.forEach(n.__getChildren__(t),function(e){i.push(n.__childCollection.__delete__(e))}),n.__parentDeleteInProgress.set(t,!1),e.all(i).then(function(){n.itemChildrenRegister.respondToParentDeleted(t),r.resolve()}),r.promise},l.__respondToChildDeleted=function(t){var n=this,r=e.defer(),i=[],o=n.__getParent__(t);return i.push(n.itemParentRegister.respondToChildDeleted(t)),o&&!n.__parentDeleteInProgress.get(o)&&i.push(n.itemChildrenRegister.respondToChildDeleted(t)),e.all(i).then(function(){r.resolve()}),r.promise},o}]),angular.module("Relate").factory("QueuedResponseDb",["$q","ValueRegister",function(e,t){var n=function(t){var n=this;n._db=t,n.queue={},n._nextId=0,n._latestResolvedId=1,n.wrapPromise=function(t,r){var i=n.nextId(),o=n._db[t](r),l=e.defer();return n.queuePromise(i,l),o.then(function(e){n.promiseGotResolved(i,e)}),l.promise},angular.forEach(["post","put","get","remove"],function(e){n[e]=function(t){return n.wrapPromise(e,t)}})};return n.prototype.nextId=function(){return this._nextId++,this._nextId},n.prototype.queuePromise=function(e,t){this.queue[e]={returnPromise:t,resolved:!1}},n.prototype.promiseGotResolved=function(e,t){var n=this.queue[e];n.result=t,n.resolved=!0,this.releasResolvedPromises()},n.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},n}]),angular.module("Relate").factory("ParentRelationshipNew",["$q",function(e){var t=function(e,t,n){this.propertyName=e,this._parentCollection=t,this._parentPopertyName=n};t.prototype._convertFromDoc=function(e){var t=e[this.propertyName];t&&this._parentCollection.getItem(t)},t.prototype._convertToDoc=function(e){return e.id},t.prototype._onItemRemove=function(e){var t=doc[this.propertyName];if(t){var n=this._parentCollection.getItem(t);n&&n._links[this._parentPopertyName]}}}]),angular.module("Relate").service("util",["$q",function(e){var t=this;t.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.createAccessFunctionDefinition=function(e,t,n){return{ModelFunctionName:e,collectionFunction:t,queuedPromise:n}},t.arrayContains=function(e,t){for(var n=e.length,r=0;n>=r;r++)if(t==e[r])return!0;return!1},t.removeFromArray=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)},t.filterIndex=function(e,t){var n=[];return angular.forEach(e,function(e){t(e)&&n.push(e)}),n},t.inheritPrototype=function(e,t){var n=e.prototype,r=t.prototype;for(var i in r)"function"==typeof r[i]&&(n[i]=r[i])},t.copyFields=function(e,t,n){angular.forEach(n,function(n){t[n]=e[n]})}}]),angular.module("Relate").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,t){this._register[e]=t},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=relate.min.js.map
