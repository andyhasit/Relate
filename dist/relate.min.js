"use strict";var c=console;angular.module("Relate",[]),angular.module("Relate").factory("BaseCollection",["$q",function(e){var n=function(){var e=this;e.__index=null,e.__db=null,e.dbDocumentType=null},t=n.prototype;return t.__postAndLoad=function(n){var t=this,i=e.defer();return n.type=t.dbDocumentType,t.__db.post(n).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";t.__db.get(e.id).then(function(e){i.resolve(t.loadDocumentFromDb(e))})}),i.promise},n}]),angular.module("Relate").factory("Collection",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var o=this,i=i||{};o.itemName=n,o.collectionName=n,o.plural=i.plural||n+"s",o.dbDocumentType=i.dbDocumentType||n,o.__db=e,o.__factoryFunction=i.factoryFunction||function(){},o.__items={},o.__relationships=[],o.__fieldNames=t.slice(),o.__fullFieldNames=t.slice(),o.__fullFieldNames.push("_id"),o.__fullFieldNames.push("_rev")};e.inheritPrototype(i,t);var o=i.prototype;return o.registerRelationship=function(e){var n=this;n.__relationships.push(e)},o.loadDocumentFromDb=function(n){var t=this,i=new t.__factoryFunction;return e.copyFields(n,i,t.__fullFieldNames),t.__items[n._id]=i,i},o.getAccessFunctionDefinitions=function(){function n(n,i,l){var a=i?n+r:n+o,c=t["__"+n+"__"];return e.createAccessFunctionDefinition(a,c,l)}var t=this,i=e.capitalizeFirstLetter,o=i(t.itemName),r=i(t.plural);return[n("new",!1,!0),n("save",!1,!0),n("delete",!1,!0),n("get",!1,!1),n("find",!0,!1),n("all",!0,!1)]},o.__get__=function(e){var n=this;return n.__items[e]},o.__all__=function(){var e=this;return Object.keys(e.__items).map(function(n){return e.__items[n]})},o.__find__=function(n){var t,i=this;if("function"==typeof n)t=n;else{if("object"!=typeof n)throw'Invalid argument for "find", must be an object or a function.';t=function(e){for(prop in n)if(e[prop]!==n[prop])return!1;return!0}}return e.filterIndex(i.__items,t)},o.__new__=function(t){var i=this,o=n.defer(),r={};return e.copyFields(t,r,i.__fieldNames),i.__postAndLoad(r).then(function(e){o.resolve(e)}),o.promise},o.__save__=function(t){var i=this,o=n.defer(),r={};return e.copyFields(t,r,i.__fullFieldNames),i.__db.put(r).then(function(e){t._rev=e.rev,o.resolve(t._rev)}),o.promise},o.__delete__=function(e){var t=this,i=n.defer(),o=[];return angular.forEach(t.__relationships,function(n){o.push(n.respondToItemDeleted(e,t))}),n.all(o).then(function(){t.__db.remove(e).then(function(n){delete t.__items[e._id],i.resolve()})}),i.promise},i}]),angular.module("Relate").factory("ItemChildrenRegister",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var o=this,i=i||{},r=i.childAlias||t.itemName,l=i.parentAlias||n.itemName;o.dbDocumentType="lnk_child_"+r+"s_of_"+l,o.__db=e,o.__parentCollection=n,o.__childCollection=t,o.__cascadeDelete=i.cascadeDelete||!1,o.__index={},o.__reverseIndex={}};e.inheritPrototype(i,t);var o=i.prototype;return o.loadDocumentFromDb=function(e){var n=this,t=e.parentId;if(n.__index[t])throw"Found duplicate item children link in database.";var i={doc:e};return n.__index[t]=i,angular.forEach(e.childrenIds,function(e){n.__reverseIndex[e]=t}),i},o.getChildren=function(e){var n=this,t=n.__index[e._id];return t?(n.__ensureIndexEntryHasLiveChildren(t),t.liveChildren):[]},o.linkChildToParent=function(e,t){var i,o=this,r=n.defer(),l=e?e._id:null,a=o.__index[l];return o.__unlinkChildFromPreviousParent(t).then(function(){o.__reverseIndex[t._id]=l,i=a?o.__addChildToIndexEntry(a,t):o.__postAndLoad({parentId:e._id,childrenIds:[t._id]}),i.then(function(){r.resolve()})}),r.promise},o.respondToParentDeleted=function(e){var t=this,i=n.defer();if(indexEntry=t.__index[e._id],indexEntry){if(t.__cascadeDelete&&indexEntry.doc.childrenIds.length>0)throw debug(indexEntry),"Cannot delete parent object as it still has children";t.__db.remove(indexEntry.doc).then(function(){delete t.__index[e._id],i.resolve()})}return i.promise},o.respondToChildDeleted=function(e){var n=this;return n.__unlinkChildFromPreviousParent(e)},o.__addChildToIndexEntry=function(t,i){var o=this,r=n.defer();return o.__ensureIndexEntryHasLiveChildren(t),e.arrayContains(t.doc.childrenIds,i._id)?r.resolve():(t.doc.childrenIds.push(i.Id),o.__db.put(t.doc).then(function(){t.liveChildren.push(i),r.resolve()})),r.promise},o.__unlinkChildFromPreviousParent=function(t){var i=this,o=n.defer(),r=i.__reverseIndex[t._id];if(r){var l=i.__index[r];e.removeFromArray(l.doc.childrenIds,t._id),i.__reverseIndex[t._id]=null,i.__db.put(l.doc).then(function(){i.__ensureIndexEntryHasLiveChildren(l),e.removeFromArray(l.liveChildren,t),o.resolve()})}else o.resolve();return o.promise},o.__ensureIndexEntryHasLiveChildren=function(e){var n=this,t=e.liveChildren;if(!t){var t=[];angular.forEach(e.doc.childrenIds,function(e){t.push(n.__childCollection.__get__(e))}),e.liveChildren=t}},i}]),angular.module("Relate").factory("ItemParentRegister",["util","$q","BaseCollection",function(e,n,t){var i=function(e,n,t,i){var o=this,i=i||{},r=i.childAlias||t.itemName,l=i.parentAlias||n.itemName;o.dbDocumentType="lnk_parent_"+l+"_of_"+r,o.__db=e,o.__index={},o.__parentCollection=n};e.inheritPrototype(i,t);var o=i.prototype;return o.loadDocumentFromDb=function(e){var n=this;if(n.__index[e.childId])throw"Found duplicate item parent link in database.";var t={document:e};return n.__index[e.childId]=t,t},o.getParent=function(e){var n=this,t=n.__index[e._id];return t?(angular.isUndefined(t.liveObject)&&(t.liveObject=n.__parentCollection.__get__(t.document.parentId)||null),t.liveObject):null},o.linkChildToParent=function(e,t){var i=this,o=n.defer(),r=e?e._id:null,l=i.__index[t._id];return l?(l.document.parentId=r,i.__db.put(l.document).then(function(n){l.document._rev=n.rev,l.liveObject=e,o.resolve()})):i.__postAndLoad({parentId:r,childId:t._id}).then(function(e){o.resolve()}),o.promise},o.respondToChildDeleted=function(e){var t=this,i=n.defer(),o=e._id,r=t.__index[o];return r&&t.__db.remove(r.document).then(function(e){delete t.__index[o],i.resolve()}),i.promise},i}]),angular.module("Relate").service("model",["$q","Collection","ParentChildRelationship",function(e,n,t){function i(e){var n=e.parent,i=e.child,o=d[n],r=d[i],l=new t(s,o,r,e);return d[l.collectionName]=l,a(l.itemParentRegister),a(l.itemChildrenRegister),l}function o(){angular.forEach(d,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(n){var t;t=n.queuedPromise?l(e,n.collectionFunction):r(e,n.collectionFunction),_[n.ModelFunctionName]=t})})}function r(e,n){return function(){return n.apply(e,arguments)}}function l(n,t){return function(){var i=arguments,o=e.defer();return h.then(function(){h=t.apply(n,i),h.then(function(e){o.resolve(e)})}),o.promise}}function a(e){var n=e.dbDocumentType;if(n in f){f[n];throw'More than one collection/relationship attempting to register dbDocumentType: "'+n+'".'}f[n]=e}function c(){var n=e.defer(),t=s.allDocs({include_docs:!0,attachments:!1});return t.then(function(e){angular.forEach(e.rows,function(e){u(e.doc)}),o(),n.resolve()})["catch"](function(e){console.log(e)}),n.promise}function u(e){var n=e.type;if(!n)throw'Could not load document "'+e._id+'" as it has no "type" field.';var t=f[n];t?t.loadDocumentFromDb(e,n):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+n+")"))}var s,_=this,d={},f={},h=e.when(),p={};_.initialize=function(e,n){s=e};var m;_.dataReady=function(){return void 0===m&&(m=e.defer(),c().then(function(){m.resolve()})),m.promise},_.printInfo=function(){angular.forEach(d,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},_.defineCollection=function(e,t,i){var o=new n(s,e,t,i);return d[o.collectionName]=o,a(o),o},_.defineRelationship=function(e){var n=e.type,t=p[n];if("function"==typeof t)return t.apply(_,[e]);throw""+e.type+" is not a valid relationship type"},p.parentChild=i}]),angular.module("Relate").factory("RelateModel",["$q","Collection","ParentChildRelationship",function(e,n,t){var i,o=function(n){var t=this;t.__db=n,t.__collections={},t.__dbDocumentTypeLoaders={},t.__lastPromiseInQueue=e.when(),t.__relationshipDefinitionFunctions={parentChild:t.__createParentChildRelationship}},r=o.prototype;return r.onDataReady=function(){var n=this;return void 0===i&&(i=e.defer(),n.__initializeModel().then(function(){i.resolve()})),i.promise},r.printInfo=function(){var e=this;angular.forEach(e.__collections,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},r.defineCollection=function(e,t,i){var o=this,r=new n(o.__db,e,t,i);return o.__collections[r.collectionName]=r,o.__registerDocumentTypeLoader(r),r},r.defineRelationship=function(e){var n=this,t=e.type,i=n.__relationshipDefinitionFunctions[t];return"function"==typeof i?i.apply(n,[e]):void alert("fail")},r.__createParentChildRelationship=function(e){var n=this,i=e.parent,o=e.child,r=n.__collections[i],l=n.__collections[o],a=new t(n.__db,r,l,e);return n.__collections[a.collectionName]=a,n.__registerDocumentTypeLoader(a.itemParentRegister),n.__registerDocumentTypeLoader(a.itemChildrenRegister),a},r.__createAccessFunctions=function(){var e=this;angular.forEach(e.__collections,function(n){angular.forEach(n.getAccessFunctionDefinitions(),function(t){var i;i=t.queuedPromise?e.__getQueuedFunction(n,t.collectionFunction):e.__getNonQueuedFunction(n,t.collectionFunction),e[t.ModelFunctionName]=i})})},r.__getNonQueuedFunction=function(e,n){return function(){return n.apply(e,arguments)}},r.__getQueuedFunction=function(n,t){var i=this;return function(){var o=arguments,r=e.defer();return i.__lastPromiseInQueue.then(function(){i.__lastPromiseInQueue=t.apply(n,o),i.__lastPromiseInQueue.then(function(e){r.resolve(e)})}),r.promise}},r.__registerDocumentTypeLoader=function(e){var n=this,t=e.dbDocumentType;if(t in n.__dbDocumentTypeLoaders){n.__dbDocumentTypeLoaders[t];throw'More than one collection/relationship attempting to register dbDocumentType: "'+t+'".'}n.__dbDocumentTypeLoaders[t]=e},r.__initializeModel=function(){var n=this,t=e.defer(),i=n.__db.allDocs({include_docs:!0,attachments:!1});return i.then(function(e){angular.forEach(e.rows,function(e){n.__addDocumentToCollection(e.doc)}),n.__createAccessFunctions(),t.resolve()})["catch"](function(e){console.log(e)}),t.promise},r.__addDocumentToCollection=function(e){var n=this,t=e.type;if(!t)throw'Could not load document "'+e._id+'" as it has no "type" field.';var i=n.__dbDocumentTypeLoaders[t];i?i.loadDocumentFromDb(e,t):console.log('Could not load document "'+e._id+'" as type was not recognised ('+t+")")},o}]),angular.module("Relate").factory("ParentChildRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,n,t,i,o){var r=function(e,o,r,l){var a=this,l=l||{};a.__parentCollectionName=o.itemName,a.__childCollectionName=r.itemName,a.__childAlias=l.childAlias||r.plural,a.__parentAlias=l.parentAlias||o.itemName,a.collectionName="lnk_"+a.__parentAlias+"_"+a.__childAlias,a.__parentDeleteInProgress=new i,a.__parentCollection=o,a.__childCollection=r,a.__cascadeDelete=l.cascadeDelete||!0,a.itemParentRegister=new n(e,o,r,l),a.itemChildrenRegister=new t(e,o,r,l),o.registerRelationship(a),r.registerRelationship(a)},l=r.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,n=o.capitalizeFirstLetter,t="get"+n(e.__childCollectionName)+n(e.__parentAlias),i="get"+n(e.__parentCollectionName)+n(e.__childAlias),r="set"+n(e.__childCollectionName)+n(e.__parentAlias);return[o.createAccessFunctionDefinition(t,e.__getParent__),o.createAccessFunctionDefinition(i,e.__getChildren__),o.createAccessFunctionDefinition(r,e.__setChildParent__)]},l.__getParent__=function(e){var n=this;return n.itemParentRegister.getParent(e)},l.__getChildren__=function(e){var n=this;return n.itemChildrenRegister.getChildren(e)},l.__setChildParent__=function(n,t){var i=this;return e.all([i.itemParentRegister.linkChildToParent(t,n),i.itemChildrenRegister.linkChildToParent(t,n)])},l.respondToItemDeleted=function(e,n){var t=this;if(n===t.__parentCollection)return t.__respondToParentDeleted(e);if(n===t.__childCollection)return t.__respondToChildDeleted(e);throw"Called respondToItemDeleted from wrong collection."},l.__respondToParentDeleted=function(n){var t=this,i=e.defer();t.__parentDeleteInProgress.set(n,!0);var o=[];return t.__cascadeDelete&&angular.forEach(t.__getChildren__(n),function(e){o.push(t.__childCollection.__delete__(e))}),t.__parentDeleteInProgress.set(n,!1),e.all(o).then(function(){t.itemChildrenRegister.respondToParentDeleted(n),i.resolve()}),i.promise},l.__respondToChildDeleted=function(n){var t=this,i=e.defer(),o=[],r=t.__getParent__(n);return o.push(t.itemParentRegister.respondToChildDeleted(n)),r&&!t.__parentDeleteInProgress.get(r)&&o.push(t.itemChildrenRegister.respondToChildDeleted(n)),e.all(o).then(function(){i.resolve()}),i.promise},r}]),angular.module("Relate").factory("QueuedResponseDb",["$q","ValueRegister",function(e,n){var t=function(n){var t=this;t._db=n,t.queue={},t._nextId=0,t._latestResolvedId=1,t.wrapPromise=function(n,i){var o=t.nextId(),r=t._db[n](i),l=e.defer();return t.queuePromise(o,l),r.then(function(e){t.promiseGotResolved(o,e)}),l.promise},angular.forEach(["post","put","get","remove"],function(e){t[e]=function(n){return t.wrapPromise(e,n)}})};return t.prototype.nextId=function(){return this._nextId++,this._nextId},t.prototype.queuePromise=function(e,n){this.queue[e]={returnPromise:n,resolved:!1}},t.prototype.promiseGotResolved=function(e,n){var t=this.queue[e];t.result=n,t.resolved=!0,this.releasResolvedPromises()},t.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},t}]),angular.module("Relate").factory("ParentRelationshipNew",["$q",function(e){var n=function(e,n,t){this.propertyName=e,this._parentCollection=n,this._parentPopertyName=t};n.prototype._convertFromDoc=function(e){var n=e[this.propertyName];n&&this._parentCollection.getItem(n)},n.prototype._convertToDoc=function(e){return e.id},n.prototype._onItemRemove=function(e){var n=doc[this.propertyName];if(n){var t=this._parentCollection.getItem(n);t&&t._links[this._parentPopertyName]}}}]),angular.module("Relate").service("util",["$q",function(e){var n=this;n.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},n.createAccessFunctionDefinition=function(e,n,t){return{ModelFunctionName:e,collectionFunction:n,queuedPromise:t}},n.arrayContains=function(e,n){for(var t=e.length,i=0;t>=i;i++)if(n==e[i])return!0;return!1},n.removeFromArray=function(e,n){var t=e.indexOf(n);t>-1&&e.splice(t,1)},n.filterIndex=function(e,n){var t=[];return angular.forEach(e,function(e){n(e)&&t.push(e)}),t},n.inheritPrototype=function(e,n){var t=e.prototype,i=n.prototype;for(var o in i)"function"==typeof i[o]&&(t[o]=i[o])},n.copyFields=function(e,n,t){angular.forEach(t,function(t){n[t]=e[t]})}}]),angular.module("Relate").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,n){this._register[e]=n},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=relate.min.js.map
