"use strict";var c=console;angular.module("Relate",[]),angular.module("Relate").factory("BaseCollection",["$q",function(e){var t=function(){var e=this;e.__index=null,e.__db=null,e.dbDocumentType=null},n=t.prototype;return n.__postAndLoad=function(t){var n=this,i=e.defer();return t.type=n.dbDocumentType,n.__db.post(t).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";n.__db.get(e.id).then(function(e){i.resolve(n.loadDocumentFromDb(e))})}),i.promise},t}]),angular.module("Relate").factory("Collection",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var r=this,i=i||{};r.itemName=t,r.collectionName=t,r.plural=i.plural||t+"s",r.dbDocumentType=i.dbDocumentType||t,r.__db=e,r.__factoryFunction=i.factoryFunction||function(){},r.__items={},r.__relationships=[],r.__fieldNames=n.slice(),r.__fullFieldNames=n.slice(),r.__fullFieldNames.push("_id"),r.__fullFieldNames.push("_rev")};e.inheritPrototype(i,n);var r=i.prototype;return r.registerRelationship=function(e,t){var n=this;n.__relationships.push(e),t&&n.__fullFieldNames.push(t)},r.loadDocumentFromDb=function(t){var n=this,i=new n.__factoryFunction;return e.copyFields(t,i,n.__fullFieldNames),i.type=n.itemName,n.__items[t._id]=i,i},r.getAccessFunctionDefinitions=function(){function t(t,i,l){var a=i?t+o:t+r,s=n[t];return e.createAccessFunctionDefinition(a,s,l)}var n=this,i=e.capitalizeFirstLetter,r=i(n.itemName),o=i(n.plural);return[t("new",!1,!0),t("get",!1,!1),t("find",!0,!1),t("all",!0,!1)]},r.get=function(e){var t=this;return t.__items[e]},r.all=function(){var e=this;return Object.keys(e.__items).map(function(t){return e.__items[t]})},r.find=function(t){var n,i=this;if("function"==typeof t)n=t;else{if("object"!=typeof t)throw'Invalid argument for "find", must be an object or a function.';n=function(e){for(prop in t)if(e[prop]!==t[prop])return!1;return!0}}return e.filterIndex(i.__items,n)},r["new"]=function(n){var i=this,r=t.defer(),o={};return e.copyFields(n,o,i.__fieldNames),i.__postAndLoad(o).then(function(e){r.resolve(e)}),r.promise},r.save=function(n){var i=this,r=t.defer(),o={};return e.copyFields(n,o,i.__fullFieldNames),i.__db.put(o).then(function(e){n._rev=e.rev,r.resolve(n._rev)}),r.promise},r["delete"]=function(e){var n=this,i=t.defer(),r=[];return angular.forEach(n.__relationships,function(t){r.push(t.respondToItemDeleted(e,n))}),t.all(r).then(function(){n.__db.remove(e).then(function(t){delete n.__items[e._id],i.resolve()})}),i.promise},i}]),angular.module("Relate").factory("ItemChildrenRegister",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var r=this,i=i||{},o=i.childAlias||n.itemName,l=i.parentAlias||t.itemName;r.dbDocumentType="lnk_child_"+o+"s_of_"+l,r.__db=e,r.__parentCollection=t,r.__childCollection=n,r.__cascadeDelete=i.cascadeDelete||!1,r.__index={},r.__reverseIndex={}};e.inheritPrototype(i,n);var r=i.prototype;return r.loadDocumentFromDb=function(e){var t=this,n=e.parentId;if(t.__index[n])throw"Found duplicate item children link in database.";var i={doc:e};return t.__index[n]=i,angular.forEach(e.childrenIds,function(e){t.__reverseIndex[e]=n}),i},r.getChildren=function(e){var t=this,n=t.__index[e._id];return n?(t.__ensureIndexEntryHasLiveChildren(n),n.liveChildren):[]},r.linkChildToParent=function(e,n){var i,r=this,o=t.defer(),l=e?e._id:null,a=r.__index[l];return r.__unlinkChildFromPreviousParent(n).then(function(){r.__reverseIndex[n._id]=l,i=a?r.__addChildToIndexEntry(a,n):r.__postAndLoad({parentId:e._id,childrenIds:[n._id]}),i.then(function(){o.resolve()})}),o.promise},r.respondToParentDeleted=function(e){var n=this,i=t.defer();if(indexEntry=n.__index[e._id],indexEntry){if(n.__cascadeDelete&&indexEntry.doc.childrenIds.length>0)throw debug(indexEntry),"Cannot delete parent object as it still has children";n.__db.remove(indexEntry.doc).then(function(){delete n.__index[e._id],i.resolve()})}return i.promise},r.respondToChildDeleted=function(e){var t=this;return t.__unlinkChildFromPreviousParent(e)},r.__addChildToIndexEntry=function(n,i){var r=this,o=t.defer();return r.__ensureIndexEntryHasLiveChildren(n),e.arrayContains(n.doc.childrenIds,i._id)?o.resolve():(n.doc.childrenIds.push(i.Id),r.__db.put(n.doc).then(function(){n.liveChildren.push(i),o.resolve()})),o.promise},r.__unlinkChildFromPreviousParent=function(n){var i=this,r=t.defer(),o=i.__reverseIndex[n._id];if(o){var l=i.__index[o];e.removeFromArray(l.doc.childrenIds,n._id),i.__reverseIndex[n._id]=null,i.__db.put(l.doc).then(function(){i.__ensureIndexEntryHasLiveChildren(l),e.removeFromArray(l.liveChildren,n),r.resolve()})}else r.resolve();return r.promise},r.__ensureIndexEntryHasLiveChildren=function(e){var t=this,n=e.liveChildren;if(!n){var n=[];angular.forEach(e.doc.childrenIds,function(e){n.push(t.__childCollection.get(e))}),e.liveChildren=n}},i}]),angular.module("Relate").factory("ItemParentRegister",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var r=this,i=i||{},o=i.childAlias||n.itemName,l=i.parentAlias||t.itemName;r.dbDocumentType="lnk_parent_"+l+"_of_"+o,r.__db=e,r.__index={},r.__parentCollection=t};e.inheritPrototype(i,n);var r=i.prototype;return r.loadDocumentFromDb=function(e){var t=this;if(t.__index[e.childId])throw"Found duplicate item parent link in database.";var n={document:e};return t.__index[e.childId]=n,n},r.getParent=function(e){var t=this,n=t.__index[e._id];return n?(angular.isUndefined(n.liveObject)&&(n.liveObject=t.__parentCollection.get(n.document.parentId)||null),n.liveObject):null},r.linkChildToParent=function(e,n){var i=this,r=t.defer(),o=e?e._id:null,l=i.__index[n._id];return l?(l.document.parentId=o,i.__db.put(l.document).then(function(t){l.document._rev=t.rev,l.liveObject=e,r.resolve()})):i.__postAndLoad({parentId:o,childId:n._id}).then(function(e){r.resolve()}),r.promise},r.respondToChildDeleted=function(e){var n=this,i=t.defer(),r=e._id,o=n.__index[r];return o&&n.__db.remove(o.document).then(function(e){delete n.__index[r],i.resolve()}),i.promise},i}]),angular.module("Relate").factory("ManyToManyRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,t,n,i,r){var o=function(e,t,n,i){var o=this,i=i||{};o.__rightCollection=n,o.__leftCollection=t;var l=("lnk_"+t.itemName+"_"+n.itemName).toLowerCase();o.__functionNameEnd="",i.qualifier&&(o.__functionNameEnd="As"+r.capitalizeFirstLetter(i.qualifier),l+="_as_"+i.qualifier.toLowerCase()),o.dbDocumentType=i.dbDocumentType||l,o.__db=e,o.__leftCollection=t,o.__rightCollection=n,o.__leftRights={},o.__rightLefts={},n.registerRelationship(o),t.registerRelationship(o)},l=o.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,t=r.capitalizeFirstLetter,n=r.createAccessFunctionDefinition,i=t(e.__leftCollection.itemName),o=t(e.__leftCollection.plural),l=t(e.__rightCollection.itemName),a=t(e.__rightCollection.plural),s=e.__functionNameEnd,u="get"+i+a+s,d="get"+l+o+s,c="add"+i+l+s,_="remove"+i+l+s,f="is"+i+"LinkedTo"+l+s;return[n(u,e.getLeftRights),n(d,e.getRightLefts),n(c,e.addLeftToRight),n(_,e.removeLeftRight),n(f,e.isLeftLinkedToRight)]},l.loadDocumentFromDb=function(e){var t=this;e.right&&e.left&&t.__updateOneRegisterWithDocument(t.__leftRights,e.left,e.right)?t.__updateOneRegisterWithDocument(t.__rightLefts,e.right,e.left):t.__sendDocumentToReusePile(e)},l.__updateOneRegisterWithDocument=function(e,t,n,i){var r=e[t];if(void 0===r)e[t]={ids:[n],docs:[i]};else{if(r.docs[n])return!1;r.ids.push(n),r.docs[n]=i}return!0},l.createLinks=function(){},l.getLeftRights=function(e){var t=this;return t.__getInitialisedEntry(t.__leftRights,e._id).items},l.getRightLefts=function(e){var t=this;return t.__getInitialisedEntry(t.__rightLefts,e._id).items},l.addLeftRight=function(t,n){var i=this;if(i.isLeftLinkedToRight(t,n))return e.when();var o=e.defer();return i.__writeLinkToDatabase(t,n).then(function(){var e=i.__getInitialisedEntry(i.__leftRights,t._id),l=i.__getInitialisedEntry(i.__rightLefts,n._id);r.addUnique(e.items,n),r.addUnique(l.items,t),o.resolve()}),o.promise},l.removeLeftRight=function(e,t){},l.isLeftLinkedToRight=function(e,t){var n=this,i=n.__leftRights[e._id];return i?r.arrayContains(i.ids,t.id):!1},l.respondToItemDeleted=function(e,t){var n=this;if(t===n.__rightCollection)return n.__respondToParentDeleted(e);if(t===n.__leftCollection)return n.__respondToChildDeleted(e);throw"Called respondToItemDeleted from wrong collection."},l.__writeLinkToDatabase=function(e,t){},l.__sendDocumentToReusePile=function(e){var t=this;t.__docsForReuse.push(e)},l.__getInitialisedEntry=function(e,t){var n=this,i=e[t];if(void 0===i)i={ids:[],docs:[doc]},e[t]=newEntry;else if(void 0===i.items){var r=e===n.__leftRights?n.__leftCollection:n.__rightCollection;i.items=[],angular.forEach(i.ids,function(e,t){var n=r.get(e);n&&i.items.push(n)})}return i},o}]),angular.module("Relate").service("model",["$q","Collection","ParentChildRelationship","ManyToManyRelationship",function(e,t,n,i){function r(e){var t=e.parent,i=e.child,r=p[t],o=p[i];return new n(_,r,o,e)}function o(e){angular.forEach(e.getAccessFunctionDefinitions(),function(t){var n;n=t.queuedPromise?a(e,t.collectionFunction):l(e,t.collectionFunction),h[t.ModelFunctionName]=n})}function l(e,t){return function(){return t.apply(e,arguments)}}function a(t,n){return function(){var i=arguments,r=e.defer();return g.then(function(){g=n.apply(t,i),g.then(function(e){r.resolve(e)})}),r.promise}}function s(e){var t=e.dbDocumentType;if(t in v){v[t];throw'More than one collection/relationship attempting to register dbDocumentType: "'+t+'".'}v[t]=e}function u(){var t=e.defer(),n=f();return n.then(function(e){angular.forEach(e.rows,function(e){d(e.doc)}),c(),t.resolve()})["catch"](function(e){console.log(e)}),t.promise}function d(e){var t=e.type;if(t){var n=v[t];n?n.loadDocumentFromDb(e,t):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+t+")"))}else console.log('Could not load document "'+e._id+'" as it has no "type" field.')}function c(){angular.forEach(m,function(e){e.createLinks()})}var _,f,h=this,p={},m={},v={},g=e.when(),y={};h.initialize=function(e,t){_=e,f=t||function(){return _.allDocs({include_docs:!0,attachments:!1})}};var C;h.dataReady=function(){return void 0===C&&(C=e.defer(),u().then(function(){C.resolve()})),C.promise},h.printInfo=function(){angular.forEach(p,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},h.collection=function(e,n,i){var r=new t(_,e,n,i);return p[r.collectionName]=r,s(r),o(r),r},h.join=function(e){var t=e.type||"parentChild",n=y[t];if("function"!=typeof n)throw""+e.type+" is not a valid relationship type";relationship=n.apply(h,[e]),o(relationship),m[relationship.collectionName]=relationship},y.parentChild=r,h.save=function(e){p[e.type].save(e)},h["delete"]=function(e){p[e.type]["delete"](e)}}]),angular.module("Relate").factory("ParentChildRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,t,n,i,r){var o=function(e,t,n,r){var o=this,r=r||{};o.__parentCollection=t,o.__childCollection=n,o.__childAlias=r.childAlias||n.plural,o.__parentAlias=r.parentAlias||t.itemName,o.__keyName="__"+o.__parentAlias,o.__parentDeleteInProgress=new i,o.__cascadeDelete=r.cascadeDelete||!0,o.__itemParent={},o.__itemChildren={},t.registerRelationship(o),n.registerRelationship(o,o.__keyName)},l=o.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,t=r.capitalizeFirstLetter,n=r.createAccessFunctionDefinition,i=t(e.__childCollection.itemName),o=t(e.__childAlias),l=t(e.__parentCollection.itemName),a=t(e.__parentAlias);return[n("get"+i+a,e.getParent),n("get"+l+o,e.getChildren),n("set"+i+a,e.setChildParent)]},l.createLinks=function(){var e=this,t=e.__keyName;angular.forEach(e.__parentCollection.__items,function(t){e.__itemChildren[t._id]=[]}),angular.forEach(e.__childCollection.__items,function(n){var i=n[t];if(i){var r=e.__parentCollection.get(i);e.__itemParent[n._id]=r,e.__itemChildren[i].push(n)}})},l.getParent=function(e){var t=this;return t.__itemParent[e._id]||null},l.getChildren=function(e){var t=this;return t.__itemChildren[e._id]},l.setChildParent=function(e,t){var n=this,i=n.__itemParent[e._id],o=t?t._id:null;return i&&r.removeFromArray(n.__itemChildren[i._id],e),t&&(void 0===n.__itemChildren[t._id]?n.__itemChildren[t._id]=[e]:n.__itemChildren[t._id].push(e)),n.__itemParent[e._id]=t,e[n.__keyName]=o,n.__childCollection.save(e)},l.respondToItemDeleted=function(e,t){var n=this;if(t===n.__parentCollection)return n.__respondToParentDeleted(e);if(t===n.__childCollection)return n.__respondToChildDeleted(e);throw"Called respondToItemDeleted from wrong collection."},l.__respondToParentDeleted=function(t){var n=this,i=e.defer();n.__parentDeleteInProgress.set(t,!0);var r=[];return n.__cascadeDelete&&angular.forEach(n.getChildren(t),function(e){r.push(n.__childCollection["delete"](e))}),n.__parentDeleteInProgress.set(t,!1),e.all(r).then(function(){n.itemChildrenRegister.respondToParentDeleted(t),i.resolve()}),i.promise},l.__respondToChildDeleted=function(t){var n=this,i=e.defer(),r=[],o=n.getParent(t);return r.push(n.itemParentRegister.respondToChildDeleted(t)),o&&!n.__parentDeleteInProgress.get(o)&&r.push(n.itemChildrenRegister.respondToChildDeleted(t)),e.all(r).then(function(){i.resolve()}),i.promise},o}]),angular.module("Relate").factory("QueuedResponseDb",["$q","ValueRegister",function(e,t){var n=function(t){var n=this;n._db=t,n.queue={},n._nextId=0,n._latestResolvedId=1,n.wrapPromise=function(t,i){var r=n.nextId(),o=n._db[t](i),l=e.defer();return n.queuePromise(r,l),o.then(function(e){n.promiseGotResolved(r,e)}),l.promise},angular.forEach(["post","put","get","remove"],function(e){n[e]=function(t){return n.wrapPromise(e,t)}})};return n.prototype.nextId=function(){return this._nextId++,this._nextId},n.prototype.queuePromise=function(e,t){this.queue[e]={returnPromise:t,resolved:!1}},n.prototype.promiseGotResolved=function(e,t){var n=this.queue[e];n.result=t,n.resolved=!0,this.releasResolvedPromises()},n.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},n}]),angular.module("Relate").factory("ParentRelationshipNew",["$q",function(e){var t=function(e,t,n){this.propertyName=e,this._parentCollection=t,this._parentPopertyName=n};t.prototype._convertFromDoc=function(e){var t=e[this.propertyName];t&&this._parentCollection.getItem(t)},t.prototype._convertToDoc=function(e){return e.id},t.prototype._onItemRemove=function(e){var t=doc[this.propertyName];if(t){var n=this._parentCollection.getItem(t);n&&n._links[this._parentPopertyName]}}}]),angular.module("Relate").service("util",["$q",function(e){var t=this;t.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.createAccessFunctionDefinition=function(e,t,n){return{ModelFunctionName:e,collectionFunction:t,queuedPromise:n}},t.arrayContains=function(e,t){for(var n=e.length,i=0;n>=i;i++)if(t===e[i])return!0;return!1},t.addUnique=function(e,n){t.arrayContains(e,n)||e.push(n)},t.addAsItem=function(e,t,n){void 0===e[t]?e[t]=[n]:e[t].push(n)},t.removeFromArray=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)},t.filterIndex=function(e,t){var n=[];return angular.forEach(e,function(e){t(e)&&n.push(e)}),n},t.inheritPrototype=function(e,t){var n=e.prototype,i=t.prototype;for(var r in i)"function"==typeof i[r]&&(n[r]=i[r])},t.copyFields=function(e,t,n){angular.forEach(n,function(n){t[n]=e[n]})}}]),angular.module("Relate").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,t){this._register[e]=t},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=relate.min.js.map
