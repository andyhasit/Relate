"use strict";var c=console;angular.module("Relate",[]),angular.module("Relate").factory("BaseCollection",["$q",function(e){var t=function(){var e=this;e.__index=null,e.__db=null},n=t.prototype;return n.__postAndLoad=function(t){var n=this,i=e.defer();return t.type=n.typeIdentifier,n.__db.post(t).then(function(e){if(!e.ok)throw console.log(e),"Error fetching data";n.__db.get(e.id).then(function(e){i.resolve(n.loadDocumentFromDb(e))})}),i.promise},t}]),angular.module("Relate").factory("Collection",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var o=this,i=i||{};o.itemName=t,o.collectionName=t,o.plural=i.plural||t+"s",o.dbDocumentType=i.dbDocumentType||t,o.__db=e,o.__factoryFunction=i.factoryFunction||function(){},o.__items={},o.__relationships=[],o.__fieldNames=n.slice(),o.__fullFieldNames=n.slice(),o.__fullFieldNames.push("_id"),o.__fullFieldNames.push("_rev")};e.inheritPrototype(i,n);var o=i.prototype;return o.registerRelationship=function(e){var t=this;t.__relationships.push(e)},o.loadDocumentFromDb=function(t){var n=this,i=new n.__factoryFunction;return e.copyFields(t,i,n.__fullFieldNames),n.__items[t._id]=i,i},o.getAccessFunctionDefinitions=function(){function t(t,i,l){var a=i?t+r:t+o,c=n["__"+t+"__"];return e.createAccessFunctionDefinition(a,c,l)}var n=this,i=e.capitalizeFirstLetter,o=i(n.itemName),r=i(n.plural);return[t("new",!1,!0),t("save",!1,!0),t("delete",!1,!0),t("get",!1,!1),t("find",!0,!1),t("all",!0,!1)]},o.__get__=function(e){var t=this;return t.__items[e]},o.__all__=function(){var e=this;return Object.keys(e.__items).map(function(t){return e.__items[t]})},o.__find__=function(t){var n,i=this;if("function"==typeof t)n=t;else{if("object"!=typeof t)throw'Invalid argument for "find", must be an object or a function.';n=function(e){for(prop in t)if(e[prop]!==t[prop])return!1;return!0}}return e.filterIndex(i.__items,n)},o.__new__=function(n){var i=this,o=t.defer(),r={};return e.copyFields(n,r,i.__fieldNames),i.__postAndLoad(r).then(function(e){o.resolve(e)}),o.promise},o.__save__=function(n){var i=this,o=t.defer(),r={};return e.copyFields(n,r,i.__fullFieldNames),i.__db.put(r).then(function(e){n._rev=e.rev,o.resolve(n._rev)}),o.promise},o.__delete__=function(e){var n=this,i=t.defer(),o=[];return angular.forEach(n.__relationships,function(t){o.push(t.respondToItemDeleted(e,n))}),t.all(o).then(function(){n.__db.remove(e).then(function(t){delete n.__items[e._id],i.resolve()})}),i.promise},i}]),angular.module("Relate").factory("ItemChildrenRegister",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var o=this,i=i||{},r=i.childAlias||n.itemName,l=i.parentAlias||t.itemName;o.dbDocumentType="lnk_child_"+r+"s_of_"+l,o.__db=e,o.__parentCollection=t,o.__childCollection=n,o.__cascadeDelete=i.cascadeDelete||!1,o.__index={},o.__reverseIndex={}};e.inheritPrototype(i,n);var o=i.prototype;return o.loadDocumentFromDb=function(e){var t=this,n=e.parentId;if(t.__index[n])throw"Found duplicate item children link in database.";var i={doc:e};return t.__index[n]=i,angular.forEach(e.childrenIds,function(e){t.__reverseIndex[e]=n}),i},o.getChildren=function(e){var t=this,n=t.__index[e._id];return n?(t.__ensureIndexEntryHasLiveChildren(n),n.liveChildren):[]},o.linkChildToParent=function(e,n){var i,o=this,r=t.defer(),l=e?e._id:null,a=o.__index[l];return o.__unlinkChildFromPreviousParent(n).then(function(){o.__reverseIndex[n._id]=l,i=a?o.__addChildToIndexEntry(a,n):o.__postAndLoad({parentId:e._id,childrenIds:[n._id]}),i.then(function(){r.resolve()})}),r.promise},o.respondToParentDeleted=function(e){var n=this,i=t.defer();if(indexEntry=n.__index[e._id],indexEntry){if(n.__cascadeDelete&&indexEntry.doc.childrenIds.length>0)throw debug(indexEntry),"Cannot delete parent object as it still has children";n.__db.remove(indexEntry.doc).then(function(){delete n.__index[e._id],i.resolve()})}return i.promise},o.respondToChildDeleted=function(e){var t=this;return t.__unlinkChildFromPreviousParent(e)},o.__addChildToIndexEntry=function(n,i){var o=this,r=t.defer();return o.__ensureIndexEntryHasLiveChildren(n),e.arrayContains(n.doc.childrenIds,i._id)?r.resolve():(n.doc.childrenIds.push(i.Id),o.__db.put(n.doc).then(function(){n.liveChildren.push(i),r.resolve()})),r.promise},o.__unlinkChildFromPreviousParent=function(n){var i=this,o=t.defer(),r=i.__reverseIndex[n._id];if(r){var l=i.__index[r];e.removeFromArray(l.doc.childrenIds,n._id),i.__reverseIndex[n._id]=null,i.__db.put(l.doc).then(function(){i.__ensureIndexEntryHasLiveChildren(l),e.removeFromArray(l.liveChildren,n),o.resolve()})}else o.resolve();return o.promise},o.__ensureIndexEntryHasLiveChildren=function(e){var t=this,n=e.liveChildren;if(!n){var n=[];angular.forEach(e.doc.childrenIds,function(e){n.push(t.__childCollection.__get__(e))}),e.liveChildren=n}},i}]),angular.module("Relate").factory("ItemParentRegister",["util","$q","BaseCollection",function(e,t,n){var i=function(e,t,n,i){var o=this,i=i||{},r=i.childAlias||n.itemName,l=i.parentAlias||t.itemName;o.dbDocumentType="lnk_parent_"+l+"_of_"+r,o.__db=e,o.__index={},o.__parentCollection=t};e.inheritPrototype(i,n);var o=i.prototype;return o.loadDocumentFromDb=function(e){var t=this;if(t.__index[e.childId])throw"Found duplicate item parent link in database.";var n={document:e};return t.__index[e.childId]=n,n},o.getParent=function(e){var t=this,n=t.__index[e._id];return n?(angular.isUndefined(n.liveObject)&&(n.liveObject=t.__parentCollection.__get__(n.document.parentId)||null),n.liveObject):null},o.linkChildToParent=function(e,n){var i=this,o=t.defer(),r=e?e._id:null,l=i.__index[n._id];return l?(l.document.parentId=r,i.__db.put(l.document).then(function(t){l.document._rev=t.rev,l.liveObject=e,o.resolve()})):i.__postAndLoad({parentId:r,childId:n._id}).then(function(e){o.resolve()}),o.promise},o.respondToChildDeleted=function(e){var n=this,i=t.defer(),o=e._id,r=n.__index[o];return r&&n.__db.remove(r.document).then(function(e){delete n.__index[o],i.resolve()}),i.promise},i}]),angular.module("Relate").service("model",["$q","Collection","ParentChildRelationship",function(e,t,n){var i=this;i.initialize=function(e,t){i.__db=e};var o;i.dataReady=function(){var t=this;return void 0===o&&(o=e.defer(),t.__initializeModel().then(function(){o.resolve()})),o.promise},i.printInfo=function(){var e=this;angular.forEach(e.__collections,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},i.defineCollection=function(e,n,i){var o=this,r=new t(o.__db,e,n,i);return o.__collections[r.collectionName]=r,o.__registerDocumentTypeLoader(r),r},i.defineRelationship=function(e){var t=this,n=e.type,i=t.__relationshipDefinitionFunctions[n];if("function"==typeof i)return i.apply(t,[e]);throw""+e.type+" is not a valid relationship type"},i.__createParentChildRelationship=function(e){var t=this,i=e.parent,o=e.child,r=t.__collections[i],l=t.__collections[o],a=new n(t.__db,r,l,e);return t.__collections[a.collectionName]=a,t.__registerDocumentTypeLoader(a.itemParentRegister),t.__registerDocumentTypeLoader(a.itemChildrenRegister),a},i.__createAccessFunctions=function(){var e=this;angular.forEach(e.__collections,function(t){angular.forEach(t.getAccessFunctionDefinitions(),function(n){var i;i=n.queuedPromise?e.__getQueuedFunction(t,n.collectionFunction):e.__getNonQueuedFunction(t,n.collectionFunction),e[n.ModelFunctionName]=i})})},i.__getNonQueuedFunction=function(e,t){return function(){return t.apply(e,arguments)}},i.__getQueuedFunction=function(t,n){var i=this;return function(){var o=arguments,r=e.defer();return i.__lastPromiseInQueue.then(function(){i.__lastPromiseInQueue=n.apply(t,o),i.__lastPromiseInQueue.then(function(e){r.resolve(e)})}),r.promise}},i.__registerDocumentTypeLoader=function(e){var t=this,n=e.dbDocumentType;if(n in t.__dbDocumentTypeLoaders){t.__dbDocumentTypeLoaders[n];throw'More than one collection/relationship attempting to register dbDocumentType: "'+n+'".'}t.__dbDocumentTypeLoaders[n]=e},i.__initializeModel=function(){var t=this,n=e.defer(),i=t.__db.allDocs({include_docs:!0,attachments:!1});return i.then(function(e){angular.forEach(e.rows,function(e){t.__addDocumentToCollection(e.doc)}),t.__createAccessFunctions(),n.resolve()})["catch"](function(e){console.log(e)}),n.promise},i.__addDocumentToCollection=function(e){var t=this,n=e.type;if(!n)throw'Could not load document "'+e._id+'" as it has no "type" field.';var i=t.__dbDocumentTypeLoaders[n];i?i.loadDocumentFromDb(e,n):(console.log(e),console.log('Could not load document "'+e._id+'" as type was not recognised ('+n+")"))},i.__collections={},i.__dbDocumentTypeLoaders={},i.__lastPromiseInQueue=e.when(),i.__relationshipDefinitionFunctions={parentChild:i.__createParentChildRelationship}}]),angular.module("Relate").factory("RelateModel",["$q","Collection","ParentChildRelationship",function(e,t,n){var i,o=function(t){var n=this;n.__db=t,n.__collections={},n.__dbDocumentTypeLoaders={},n.__lastPromiseInQueue=e.when(),n.__relationshipDefinitionFunctions={parentChild:n.__createParentChildRelationship}},r=o.prototype;return r.onDataReady=function(){var t=this;return void 0===i&&(i=e.defer(),t.__initializeModel().then(function(){i.resolve()})),i.promise},r.printInfo=function(){var e=this;angular.forEach(e.__collections,function(e){angular.forEach(e.getAccessFunctionDefinitions(),function(e){console.log("model."+e.ModelFunctionName)})})},r.defineCollection=function(e,n,i){var o=this,r=new t(o.__db,e,n,i);return o.__collections[r.collectionName]=r,o.__registerDocumentTypeLoader(r),r},r.defineRelationship=function(e){var t=this,n=e.type,i=t.__relationshipDefinitionFunctions[n];return"function"==typeof i?i.apply(t,[e]):void alert("fail")},r.__createParentChildRelationship=function(e){var t=this,i=e.parent,o=e.child,r=t.__collections[i],l=t.__collections[o],a=new n(t.__db,r,l,e);return t.__collections[a.collectionName]=a,t.__registerDocumentTypeLoader(a.itemParentRegister),t.__registerDocumentTypeLoader(a.itemChildrenRegister),a},r.__createAccessFunctions=function(){var e=this;angular.forEach(e.__collections,function(t){angular.forEach(t.getAccessFunctionDefinitions(),function(n){var i;i=n.queuedPromise?e.__getQueuedFunction(t,n.collectionFunction):e.__getNonQueuedFunction(t,n.collectionFunction),e[n.ModelFunctionName]=i})})},r.__getNonQueuedFunction=function(e,t){return function(){return t.apply(e,arguments)}},r.__getQueuedFunction=function(t,n){var i=this;return function(){var o=arguments,r=e.defer();return i.__lastPromiseInQueue.then(function(){i.__lastPromiseInQueue=n.apply(t,o),i.__lastPromiseInQueue.then(function(e){r.resolve(e)})}),r.promise}},r.__registerDocumentTypeLoader=function(e){var t=this,n=e.dbDocumentType;if(n in t.__dbDocumentTypeLoaders){t.__dbDocumentTypeLoaders[n];throw'More than one collection/relationship attempting to register dbDocumentType: "'+n+'".'}t.__dbDocumentTypeLoaders[n]=e},r.__initializeModel=function(){var t=this,n=e.defer(),i=t.__db.allDocs({include_docs:!0,attachments:!1});return i.then(function(e){angular.forEach(e.rows,function(e){t.__addDocumentToCollection(e.doc)}),t.__createAccessFunctions(),n.resolve()})["catch"](function(e){console.log(e)}),n.promise},r.__addDocumentToCollection=function(e){var t=this,n=e.type;if(!n)throw'Could not load document "'+e._id+'" as it has no "type" field.';var i=t.__dbDocumentTypeLoaders[n];i?i.loadDocumentFromDb(e,n):console.log('Could not load document "'+e._id+'" as type was not recognised ('+n+")")},o}]),angular.module("Relate").factory("ParentChildRelationship",["$q","ItemParentRegister","ItemChildrenRegister","ValueRegister","util",function(e,t,n,i,o){var r=function(e,o,r,l){var a=this,l=l||{};a.__parentCollectionName=o.itemName,a.__childCollectionName=r.itemName,a.__childAlias=l.childAlias||r.plural,a.__parentAlias=l.parentAlias||o.itemName,a.collectionName="lnk_"+a.__parentAlias+"_"+a.__childAlias,a.__parentDeleteInProgress=new i,a.__parentCollection=o,a.__childCollection=r,a.__cascadeDelete=l.cascadeDelete||!0,a.itemParentRegister=new t(e,o,r,l),a.itemChildrenRegister=new n(e,o,r,l),o.registerRelationship(a),r.registerRelationship(a)},l=r.prototype;return l.getAccessFunctionDefinitions=function(){var e=this,t=o.capitalizeFirstLetter,n="get"+t(e.__childCollectionName)+t(e.__parentAlias),i="get"+t(e.__parentCollectionName)+t(e.__childAlias),r="set"+t(e.__childCollectionName)+t(e.__parentAlias);return[o.createAccessFunctionDefinition(n,e.__getParent__),o.createAccessFunctionDefinition(i,e.__getChildren__),o.createAccessFunctionDefinition(r,e.__setChildParent__)]},l.__getParent__=function(e){var t=this;return t.itemParentRegister.getParent(e)},l.__getChildren__=function(e){var t=this;return t.itemChildrenRegister.getChildren(e)},l.__setChildParent__=function(t,n){var i=this;return e.all([i.itemParentRegister.linkChildToParent(n,t),i.itemChildrenRegister.linkChildToParent(n,t)])},l.respondToItemDeleted=function(e,t){var n=this;if(t===n.__parentCollection)return n.__respondToParentDeleted(e);if(t===n.__childCollection)return n.__respondToChildDeleted(e);throw"Called respondToItemDeleted from wrong collection."},l.__respondToParentDeleted=function(t){var n=this,i=e.defer();n.__parentDeleteInProgress.set(t,!0);var o=[];return n.__cascadeDelete&&angular.forEach(n.__getChildren__(t),function(e){o.push(n.__childCollection.__delete__(e))}),n.__parentDeleteInProgress.set(t,!1),e.all(o).then(function(){n.itemChildrenRegister.respondToParentDeleted(t),i.resolve()}),i.promise},l.__respondToChildDeleted=function(t){var n=this,i=e.defer(),o=[],r=n.__getParent__(t);return o.push(n.itemParentRegister.respondToChildDeleted(t)),r&&!n.__parentDeleteInProgress.get(r)&&o.push(n.itemChildrenRegister.respondToChildDeleted(t)),e.all(o).then(function(){i.resolve()}),i.promise},r}]),angular.module("Relate").factory("QueuedResponseDb",["$q","ValueRegister",function(e,t){var n=function(t){var n=this;n._db=t,n.queue={},n._nextId=0,n._latestResolvedId=1,n.wrapPromise=function(t,i){var o=n.nextId(),r=n._db[t](i),l=e.defer();return n.queuePromise(o,l),r.then(function(e){n.promiseGotResolved(o,e)}),l.promise},angular.forEach(["post","put","get","remove"],function(e){n[e]=function(t){return n.wrapPromise(e,t)}})};return n.prototype.nextId=function(){return this._nextId++,this._nextId},n.prototype.queuePromise=function(e,t){this.queue[e]={returnPromise:t,resolved:!1}},n.prototype.promiseGotResolved=function(e,t){var n=this.queue[e];n.result=t,n.resolved=!0,this.releasResolvedPromises()},n.prototype.releasResolvedPromises=function(){for(var e=!1;!e;)entry=this.queue[this._latestResolvedId],entry&&entry.resolved?(entry.returnPromise.resolve(entry.result),this._latestResolvedId++):e=!0},n}]),angular.module("Relate").factory("ParentRelationshipNew",["$q",function(e){var t=function(e,t,n){this.propertyName=e,this._parentCollection=t,this._parentPopertyName=n};t.prototype._convertFromDoc=function(e){var t=e[this.propertyName];t&&this._parentCollection.getItem(t)},t.prototype._convertToDoc=function(e){return e.id},t.prototype._onItemRemove=function(e){var t=doc[this.propertyName];if(t){var n=this._parentCollection.getItem(t);n&&n._links[this._parentPopertyName]}}}]),angular.module("Relate").service("util",["$q",function(e){var t=this;t.capitalizeFirstLetter=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},t.createAccessFunctionDefinition=function(e,t,n){return{ModelFunctionName:e,collectionFunction:t,queuedPromise:n}},t.arrayContains=function(e,t){for(var n=e.length,i=0;n>=i;i++)if(t==e[i])return!0;return!1},t.removeFromArray=function(e,t){var n=e.indexOf(t);n>-1&&e.splice(n,1)},t.filterIndex=function(e,t){var n=[];return angular.forEach(e,function(e){t(e)&&n.push(e)}),n},t.inheritPrototype=function(e,t){var n=e.prototype,i=t.prototype;for(var o in i)"function"==typeof i[o]&&(n[o]=i[o])},t.copyFields=function(e,t,n){angular.forEach(n,function(n){t[n]=e[n]})}}]),angular.module("Relate").factory("ValueRegister",function(){var e=function(){this._register={}};return e.prototype.set=function(e,t){this._register[e]=t},e.prototype.get=function(e){return this._register[e]},e});
//# sourceMappingURL=relate.min.js.map
